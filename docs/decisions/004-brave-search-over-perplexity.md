# ADR 004: Brave Search вместо Perplexity для web_search tool

**Дата:** 2025-10-15
**Статус:** Принято

---

## Контекст

Для реализации задачи 2.4 из roadmap.md требовалось добавить web_search tool, который позволит Claude искать актуальную информацию в интернете.

**Требования:**
- Поиск актуальной информации (новости, курсы валют, погода, технические обновления)
- Простая интеграция через REST API
- Бесплатный или недорогой tier для тестирования
- Надёжность и качество результатов
- Минимальная latency (быстрые ответы)

**Почему важно:**
- У Claude уже есть база знаний из документов проекта (knowledge/)
- Но для актуальной информации (новости, курсы, обновления) нужен веб-поиск
- Нужен баланс между функциональностью и сложностью

---

## Решение

Выбрали **Brave Search API** для реализации web_search tool.

---

## Причины

### 1. **Избегаем дублирования AI-агентов**

Perplexity сам является AI-агентом, который:
- Принимает запрос
- Ищет в интернете
- Анализирует результаты через LLM
- Возвращает готовый ответ

**Проблема:** У нас уже есть Claude для анализа и синтеза информации. Использование Perplexity создаёт **два AI-агента для одной задачи**.

**Brave Search:**
- Возвращает RAW результаты поиска (title, URL, description)
- Claude САМ анализирует и синтезирует ответ
- **Один AI-агент** (Claude) с доступом к поисковым результатам

### 2. **Простота интеграции**

**Brave Search API:**
```typescript
fetch('https://api.search.brave.com/res/v1/web/search?q=query', {
  headers: { 'X-Subscription-Token': apiKey }
})
```

- REST API с простой аутентификацией (один header)
- Прямой ответ с JSON массивом результатов
- Минимальная обработка данных

**Perplexity API:**
- Требует более сложную интеграцию
- Streaming ответы (обработка частей ответа)
- Управление контекстом между запросами

### 3. **Стоимость и лимиты**

**Brave Search Free Tier:**
- 2000 запросов/месяц
- 1 запрос/секунду
- $0 стоимость
- API key мгновенно (без очереди)

**Perplexity:**
- Платные тарифы
- API доступ требует подписку
- Меньше прозрачности в лимитах

### 4. **Latency и производительность**

**Brave Search:**
- ~200-500ms среднее время ответа
- Один HTTP запрос → результаты
- Claude анализирует параллельно

**Perplexity:**
- Дополнительная latency из-за собственного LLM анализа
- Streaming ответы требуют больше времени
- Двойная обработка (Perplexity LLM + Claude LLM)

### 5. **Контроль и гибкость**

**Brave Search:**
- Claude видит ВСЕ результаты поиска
- Claude может выбрать релевантные источники
- Можно настроить count, region, language
- Полный контроль над форматированием ответа

**Perplexity:**
- Получаем готовый ответ (чёрный ящик)
- Меньше контроля над источниками
- Claude не может переосмыслить данные по-своему

---

## Последствия

### Плюсы

- ✅ **Единый AI-агент**: Claude контролирует весь process reasoning
- ✅ **Простая интеграция**: 100 строк кода в [lib/ai/tools/web-search.ts](../../lib/ai/tools/web-search.ts)
- ✅ **Бесплатный tier**: 2000 запросов/месяц достаточно для тестирования
- ✅ **Быстрые ответы**: ~200-500ms latency
- ✅ **Прозрачность**: Claude видит источники, может ссылаться на URL
- ✅ **Гибкость**: Можно настроить параметры поиска (count, region, lang)
- ✅ **Отладка**: Легко понять что идёт не так (простой JSON response)

### Минусы

- ❌ **Качество поиска**: Brave Search не так популярен как Google
  - *Mitigation:* Brave индексирует ~10B страниц, достаточно для большинства запросов
- ❌ **Нет AI-обработки результатов из коробки**
  - *Mitigation:* У нас есть Claude, который делает это лучше
- ❌ **Лимит 2000 req/month** на free tier
  - *Mitigation:* Платный tier $5/1000 requests при необходимости
- ❌ **Нужна дополнительная обработка в Claude**
  - *Mitigation:* Claude отлично справляется с анализом search results

---

## Альтернативы

### Альтернатива 1: Perplexity API

**Что это:** AI-powered поисковая система с встроенным LLM для анализа

**Почему отклонили:**
- Два AI-агента для одной задачи (Perplexity LLM + Claude)
- Более сложная интеграция (streaming, context management)
- Меньше контроля над источниками и форматированием
- Платный доступ к API

**Когда может быть лучше:**
- Когда НЕТ своего LLM (например, обычное веб-приложение без AI)
- Нужны готовые AI-ответы без дополнительной обработки
- Критична максимальная точность (Perplexity использует несколько LLM)

### Альтернатива 2: Google Search API

**Что это:** Official Google Custom Search API

**Почему отклонили:**
- Free tier только 100 запросов/день (3000/month)
- Платный tier дорогой: $5 per 1000 queries
- Более сложная настройка (Custom Search Engine setup)
- Rate limits более строгие

**Когда может быть лучше:**
- Критично качество поиска (Google = золотой стандарт)
- Большой бюджет на API
- Нужны специфичные Google features (Knowledge Graph, snippets)

### Альтернатива 3: Tavily Search API

**Что это:** Search API оптимизированный для LLM использования

**Почему отклонили:**
- Менее известный сервис (больше риск)
- Нет бесплатного tier
- Меньше документации и community support

**Когда может быть лучше:**
- Специфичные требования к формату данных для LLM
- Готовы платить за специализированный сервис
- Нужна более глубокая интеграция с AI workflows

---

## Ссылки и ресурсы

- [Brave Search API Documentation](https://brave.com/search/api/)
- [Brave Search API Dashboard](https://api-dashboard.search.brave.com/)
- [Vercel AI Chatbot - Tool Pattern](https://github.com/vercel/ai-chatbot)
- [AI SDK - Tools and Tool Calling](https://ai-sdk.dev/docs/ai-sdk-core/tools-and-tool-calling)
- [lib/ai/tools/web-search.ts](../../lib/ai/tools/web-search.ts) - Реализация

---

## Примечания

**Интеграция прошла успешно:**
- Создан tool за ~2 часа работы
- API key получен мгновенно (BSAyJ8IbjSkIIASijGk2Z8SMBnlJRKr)
- Интеграция в route.ts без проблем
- Тестирование: все запросы возвращают 200 OK

**Выявленная проблема:**
- Environment variables приоритет: shell > .env.local
- Решение: Документировано в [docs/troubleshooting.md](../troubleshooting.md)

**Результаты тестирования:**
```
[webSearch] Response status: 200  ✅
Query: "ошибка 422 причины" - 5 results
Query: "test web search function 2025" - 3 results
Query: "San Francisco weather today" - 5 results
```

---

## История изменений

- **2025-10-15** - Документ создан (Claude Code)
- **2025-10-15** - Решение успешно реализовано и протестировано
